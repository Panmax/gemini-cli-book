# 第十章：安全与沙盒

作为一个能够执行 shell 命令和修改文件的工具，Gemini CLI 的运行权限非常高。这在提升生产力的同时，也引入了潜在的安全风险，特别是当 AI 根据复杂或模糊的提示生成命令时。

为了解决这个问题，Gemini CLI 内置了强大的**沙盒 (sandboxing)** 功能。本章将解释为什么沙盒至关重要，以及如何使用它来保护您的系统。

## 为什么沙盒很重要？

沙盒将潜在的危险操作（如 shell 命令或文件修改）与您的主机系统隔离开来，在 AI 的行为和您的环境之间建立了一道安全屏障。其主要优点包括：

- **安全性**: 防止意外的命令（例如 `rm -rf /`）对系统造成损害或导致数据丢失。
- **隔离性**: 将文件系统的访问权限严格限制在您当前的项目目录内。
- **保障性**: 在处理不受信任的代码或实验性命令时降低风险。

## 沙盒的实现方式

Gemini CLI 根据您的操作系统提供了不同的沙盒实现方法。

### 1. macOS Seatbelt (仅限 macOS)
对于 macOS 用户，CLI 利用了轻量级的内置工具 `sandbox-exec`（也称为 Seatbelt）。它默认会限制文件写入等操作只能在项目目录内进行，同时仍然允许网络访问。这在安全性和便利性之间取得了很好的平衡，且几乎无需配置。

### 2. 基于容器 (Docker/Podman)
为了实现跨平台和最大程度的隔离，您可以使用基于容器的方法，配合 Docker 或 Podman。这种方法将 CLI 的工具执行环境运行在一个容器内部，提供了完全的进程和文件系统隔离。这是最安全的方法，但需要您预先安装 Docker 或 Podman。

## 如何启用和配置沙盒

您可以通过三种方式启用沙盒，按优先级从高到低排列如下：

**1. 命令行标志 (最高优先级)**
为单次会话启用沙盒的最简单方法是使用 `-s` 或 `--sandbox` 标志。
```bash
gemini -s -p "运行测试套件"
```

**2. 环境变量**
您可以通过设置环境变量来为整个终端会话启用沙盒。
```bash
export GEMINI_SANDBOX=true
gemini -p "分析代码结构"
```
您也可以指定具体的方法，例如 `export GEMINI_SANDBOX=docker`。

**3. `settings.json` 文件 (默认设置)**
要为所有会话默认启用沙盒，请将以下内容添加到您的 `settings.json` 文件中：
```json
{
  "tools": {
    "sandbox": true
  }
}
```
您也可以在这里指定方法，例如 `"sandbox": "docker"`。

## 排查常见问题

- **"Operation not permitted" (操作不允许)**: 这说明沙盒正在正常工作！AI 试图执行超出其允许范围的操作。如果这个操作是您期望的，您可能需要使用一个更宽松的配置文件（适用于 macOS）或调整容器的卷挂载。
- **沙盒中缺少命令**: 如果一个命令在您的主机上能用，但在沙盒中不行，那是因为该工具没有被安装在容器里。您可能需要自定义 Dockerfile 来添加必要的依赖。
- **网络问题**: 如果与网络相关的工具失败了，请确保您的沙盒配置文件或容器配置允许网络访问。

通过使用沙盒功能，您可以放心地利用 Gemini CLI 工具的全部威力，同时为您的系统保持高水平的安全保障。
